{% extends 'base.html' %}

{% load i18n %}

{% load lao_filters %}

{% load coffee_filters %}

{% block title %}{{ coffee.name }} - ‡∫Æ‡ªâ‡∫≤‡∫ô‡∫Å‡∫≤‡ªÄ‡∫ü{% endblock %}

{% block extra_css %}
<style>
    .scrollbar-hide {
        -ms-overflow-style: none;  /* Internet Explorer 10+ */
        scrollbar-width: none;  /* Firefox */
    }
    .scrollbar-hide::-webkit-scrollbar {
        display: none;  /* Safari and Chrome */
    }

    /* Optional: Add smooth scroll behavior for better UX */
    .scrollbar-hide {
        scroll-behavior: smooth;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-8">
        <ol class="flex items-center space-x-2 text-sm">
            <li><a href="{% url 'coffee_list' %}" class="text-amber-600 hover:text-amber-700">{% trans "All Coffee" %}</a></li>
            <li class="">/</li>
            {% if coffee.categories.exists %}
                {% with first_category=coffee.categories.first %}
                <li><a href="{% url 'category' first_category.id %}" class="text-amber-600 hover:text-amber-700">{{ first_category.name }}</a></li>
                {% endwith %}
            {% else %}
                <li class="text-gray-500">{% trans "Coffee Category" %}</li>
            {% endif %}
            <li class="">/</li>
            <li class="">{{ coffee.name }}</li>
        </ol>
    </nav>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-12">
        
        <!-- Coffee Image Gallery - Taobao Style -->
        <div x-data="imageGallery()" class="flex space-x-3">
            <!-- Vertical Thumbnail Gallery (Left Side) - Taobao Style -->
            <div class="relative flex-shrink-0" x-show="totalImages > 1">
                <!-- Thumbnail container with smooth scroll -->
                <div class="relative h-96 w-16 overflow-hidden">
                    <div class="flex flex-col space-y-1 transition-transform duration-300 ease-out"
                         id="thumbnail-container"
                         :style="{ transform: 'translateY(-' + (scrollOffset * 68) + 'px)' }">
                        <!-- Main product image thumbnail -->
                        {% if coffee.images %}
                        <div class="flex-shrink-0 aspect-square w-16 h-16 bg-white border border-gray-200 rounded cursor-pointer overflow-hidden transition-all duration-200 hover:border-amber-400 hover:shadow-md"
                             :class="{ 'border-amber-500 shadow-md ring-2 ring-amber-200': activeImage === '{{ coffee.images.url }}' }"
                             @click="setActiveImage('{{ coffee.images.url }}', 0)"
                             @mouseenter="setActiveImage('{{ coffee.images.url }}', 0)">
                            <img src="{{ coffee.images.url }}"
                                 alt="{{ coffee.name }}"
                                 class="w-full h-full object-cover">
                        </div>
                        {% endif %}

                        <!-- Gallery images thumbnails -->
                        {% for gallery_image in coffee.gallery_images.all %}
                        <div class="flex-shrink-0 aspect-square w-16 h-16 bg-white border border-gray-200 rounded cursor-pointer overflow-hidden transition-all duration-200 hover:border-amber-400 hover:shadow-md"
                             :class="{ 'border-amber-500 shadow-md ring-2 ring-amber-200': activeImage === '{{ gallery_image.image.url }}' }"
                             @click="setActiveImage('{{ gallery_image.image.url }}', {{ forloop.counter }})"
                             @mouseenter="setActiveImage('{{ gallery_image.image.url }}', {{ forloop.counter }})">
                            <img src="{{ gallery_image.image.url }}"
                                 alt="{{ gallery_image.alt_text|default:coffee.name }}"
                                 class="w-full h-full object-cover">
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Smooth scroll buttons - Taobao style -->
                <template x-if="canScrollUp">
                    <button @click="scrollUp()"
                            class="absolute -top-1 left-1/2 transform -translate-x-1/2 bg-white shadow-lg border border-gray-200 rounded-full w-6 h-6 flex items-center justify-center hover:bg-gray-50 hover:shadow-xl transition-all duration-200 z-10">
                        <i class="fas fa-chevron-up text-gray-500 text-xs"></i>
                    </button>
                </template>

                <template x-if="canScrollDown">
                    <button @click="scrollDown()"
                            class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 bg-white shadow-lg border border-gray-200 rounded-full w-6 h-6 flex items-center justify-center hover:bg-gray-50 hover:shadow-xl transition-all duration-200 z-10">
                        <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
                    </button>
                </template>
            </div>

            <!-- Single thumbnail for single image -->
            <div x-show="totalImages === 1" class="flex-shrink-0">
                {% if coffee.images %}
                <div class="aspect-square w-16 h-16 bg-white border-2 border-amber-500 rounded overflow-hidden shadow-md ring-2 ring-amber-200">
                    <img src="{{ coffee.images.url }}"
                         alt="{{ coffee.name }}"
                         class="w-full h-full object-cover">
                </div>
                {% endif %}
            </div>

            <!-- Main Image Display (Right Side) - Taobao Style -->
            <div class="flex-1 relative group">
                <div class="aspect-square bg-white border border-gray-200 rounded-lg flex items-center justify-center relative overflow-hidden shadow-sm">
                    <!-- Show image if activeImage exists -->
                    <template x-if="activeImage">
                        <img :src="activeImage"
                             alt="{{ coffee.name }}"
                             class="w-full h-full object-cover transition-all duration-300"
                             x-transition:enter="transition ease-out duration-300"
                             x-transition:enter-start="opacity-0 transform scale-105"
                             x-transition:enter-end="opacity-100 transform scale-100">
                    </template>

                    <!-- Fallback icon when no image -->
                    <template x-if="!activeImage">
                        <i class="fas fa-coffee text-8xl text-gray-300"></i>
                    </template>

                    <!-- Subtle navigation arrows - only show on hover -->
                    <template x-if="totalImages > 1">
                        <div class="absolute inset-0 flex items-center justify-between p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <button @click="previousImage()"
                                    class="bg-white bg-opacity-90 text-gray-700 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-100 hover:shadow-md transition-all duration-200 backdrop-blur-sm">
                                <i class="fas fa-chevron-left text-sm"></i>
                            </button>
                            <button @click="nextImage()"
                                    class="bg-white bg-opacity-90 text-gray-700 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-100 hover:shadow-md transition-all duration-200 backdrop-blur-sm">
                                <i class="fas fa-chevron-right text-sm"></i>
                            </button>
                        </div>
                    </template>

                    <!-- Clean image counter -->
                    <template x-if="totalImages > 1">
                        <div class="absolute bottom-3 right-3 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs backdrop-blur-sm">
                            <span x-text="currentImageIndex + 1"></span>/<span x-text="totalImages"></span>
                        </div>
                    </template>

                    <!-- Badges positioned cleanly -->
                    <div class="absolute top-3 left-3 space-y-1">
                        {% if coffee.is_fresh %}
                        <div class="bg-green-500 text-white px-2 py-1 rounded text-xs font-medium shadow-sm">
                            <i class="fas fa-leaf mr-1"></i>{% trans "Fresh" %}
                        </div>
                        {% endif %}

                        {% if coffee.stock_quantity < 10 %}
                        <div class="bg-red-500 text-white px-2 py-1 rounded text-xs font-medium shadow-sm">
                            <i class="fas fa-exclamation-triangle mr-1"></i>{% trans "Low Stock" %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Rating Badge -->
                    {% if avg_rating > 0 %}
                    <div class="absolute top-3 right-3 bg-yellow-400 text-yellow-900 px-2 py-1 rounded text-xs font-medium shadow-sm">
                        <i class="fas fa-star mr-1"></i>{{ avg_rating|floatformat:1 }}
                    </div>
                    {% endif %}
                </div>

                <!-- Zoom hint -->
                <div class="absolute bottom-3 left-3 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 backdrop-blur-sm">
                    <i class="fas fa-search-plus mr-1"></i>Click to zoom
                </div>
        </div>
    </div>
        
        <!-- Coffee Details -->
        <div class="space-y-6" x-data="coffeeSelector()">
            <div>
                <h1 class="text-3xl font-bold mb-2">{{ coffee.name }}</h1>
                <p class="text-lg">{{ coffee.coffee_bean.name }} ({{ coffee.coffee_bean.get_origin_display }})</p>
            </div>
            
            <!-- Rating -->
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    {% for i in "12345" %}
                        {% if forloop.counter <= avg_rating %}
                        <i class="fas fa-star text-yellow-400"></i>
                        {% else %}
                        <i class="far fa-star text-gray-300"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="">{{ avg_rating|floatformat:1 }}/5.0 ({% blocktrans count review_count=review_count %}{{ review_count }} review{% plural %}{{ review_count }} reviews{% endblocktrans %})</span>
            </div>
            
            <!-- Price -->
            <div class="border-t border-gray-200 pt-6">
                <div class="flex items-baseline space-x-4">
                    <span class="text-4xl font-bold text-amber-600">{{ coffee.price|lao_currency }}</span>
                    <span class="text-gray-500">{{ coffee.weight }}{{ coffee.weight_unit }}</span>
                </div>
                <p class="text-sm text-gray-500 mt-1">{{ coffee.price_per_unit|lao_currency }}/100g</p>
            </div>
            
            <!-- Select Roast (Radio) -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold mb-4">{% trans "Roasting Type" %}</h3>
                <fieldset class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                {% for roast in available_roasts %}
                    <label class="flex items-center gap-3 px-4 py-2 border text-amber-600 rounded-lg cursor-pointer transition
                                hover:border-amber-400"
                        :class="selectedRoastId == {{ roast.id }} ? 'bg-amber-50 border-amber-500 ring-1 ring-amber-200' : 'border-gray-300'">
                    <input type="radio"
                            name="roast"
                            value="{{ roast.id }}"
                            class="h-4 w-4 text-amber-600 focus:ring-amber-500"
                            x-model="selectedRoastId"
                            @change="onRoastChange()"
                            {% if roast.id == coffee.roast_level.id %}checked{% endif %}>
                    <span class="font-medium">{{ roast.get_name_display }}</span>
                    </label>
                {% endfor %}
                </fieldset>
            </div>
  
            <!-- Select Grind (Radio) -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold mb-4">{% trans "Beans" %}</h3>
                <fieldset class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                {% for grind in available_grinds %}
                    {# We'll enable/disable these via Alpine based on selected roast + variants_index #}
                    <label class="flex items-center gap-3 px-4 py-2 border text-amber-600 rounded-lg cursor-pointer transition"
                        :class="isGrindAvailable('{{ grind }}') ? 
                                (selectedGrind == '{{ grind }}' ? 'bg-amber-50 border-amber-500 ring-1 ring-amber-200' : 'border-gray-300 hover:border-amber-400') :
                                'border-gray-200 opacity-50 cursor-not-allowed'">
                    <input type="radio"
                            name="grind"
                            value="{{ grind }}"
                            class="h-4 w-4 text-amber-600 focus:ring-amber-500"
                            x-model="selectedGrind"
                            :disabled="!isGrindAvailable('{{ grind }}')"
                            @change="onGrindChange()"
                            {% if grind == coffee.grind_type %}checked{% endif %}>
                    <span class="font-medium">{{ grind|capfirst }}</span>
                    </label>
                {% endfor %}
                </fieldset>
            </div>

            
            <!-- Categories -->
            {% if coffee.categories.exists %}
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold mb-4">{% trans "Categories" %}</h3>
                <div class="flex flex-wrap gap-2">
                    {% for category in coffee.categories.all %}
                    <span class="bg-amber-100 text-amber-600 px-3 py-1 rounded-full text-sm">
                        {{ category.name }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Flavor Profile -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold mb-4">{% trans "Flavor and Aroma" %}</h3>
                {% if coffee.coffee_bean.flavor_notes %}
                <p class=" mb-4">{{ coffee.coffee_bean.flavor_notes }}</p>
                {% endif %}
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class=" text-sm">{% trans "Acidity" %}</span>
                        <div class="flex items-center mt-1">
                            {% for i in "12345" %}
                                {% if forloop.counter <= coffee.coffee_bean.acidity_level %}
                                <div class="w-4 h-4 bg-amber-400 rounded-full mr-1"></div>
                                {% else %}
                                <div class="w-4 h-4 bg-gray-200 rounded-full mr-1"></div>
                                {% endif %}
                            {% endfor %}
                            <span class="ml-2 text-sm ">{{ coffee.coffee_bean.acidity_level }}/5</span>
                        </div>
                    </div>
                    <div>
                        <span class=" text-sm">{% trans "Body" %}</span>
                        <div class="flex items-center mt-1">
                            {% for i in "12345" %}
                                {% if forloop.counter <= coffee.coffee_bean.body_level %}
                                <div class="w-4 h-4 bg-amber-600 rounded-full mr-1"></div>
                                {% else %}
                                <div class="w-4 h-4 bg-gray-200 rounded-full mr-1"></div>
                                {% endif %}
                            {% endfor %}
                            <span class="ml-2 text-sm ">{{ coffee.coffee_bean.body_level }}/5</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="border-t border-gray-200 pt-6 space-y-4">
                <!-- WhatsApp Order Button -->
                <div class="space-y-3">
                    <!-- Order via WhatsApp (uses selected variant) -->
                        <button @click="sendWhatsAppOrder()"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg transform hover:scale-105">
                        <i class="fab fa-whatsapp text-xl"></i>
                        <span>{% trans "Order via WhatsApp" %}</span>
                        </button>


                    <!-- Secondary action buttons -->
                    <div class="grid grid-cols-2 gap-3">
                        <button class="flex items-center justify-center space-x-2 border-2 border-amber-500 text-amber-600 hover:bg-amber-500 hover:text-white font-medium py-2 px-4 rounded-lg transition-all duration-200"
                                onclick="addToWishlist('{{ coffee.slug }}')">
                            <i class="fas fa-heart text-sm"></i>
                            <span>{% trans "Like" %}</span>
                        </button>

                        <button class="flex items-center justify-center space-x-2 border-2 border-gray-300 text-gray-600 hover:bg-gray-100 font-medium py-2 px-4 rounded-lg transition-all duration-200"
                                onclick="shareProduct()">
                            <i class="fas fa-share-alt text-sm"></i>
                            <span>{% trans "Share" %}</span>
                        </button>
                    </div>
                </div>

                <!-- Stock Status -->
                <div class="flex items-center space-x-2 text-sm">
                    {% if coffee.stock_quantity > 0 %}
                        <div class="flex items-center text-green-600">
                            <i class="fas fa-check-circle mr-1"></i>
                            <span>{% trans "In Stock" %} ({{ coffee.stock_quantity }} {% trans "bags" %})</span>
                        </div>
                    {% else %}
                        <div class="flex items-center text-red-600">
                            <i class="fas fa-times-circle mr-1"></i>
                            <span>{% trans "Out of Stock" %}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabs -->
    <div x-data="{ activeTab: 'description' }" class="mb-12">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8">
                <button @click="activeTab = 'description'" 
                        :class="activeTab === 'description' ? 'border-amber-500 text-amber-600' : 'border-transparent text-gray-500 hover:'"
                        class="py-2 px-1 border-b-2 font-medium text-sm transition">
                    {% trans "Description" %}
                </button>
                <button @click="activeTab = 'brewing'" 
                        :class="activeTab === 'brewing' ? 'border-amber-500 text-amber-600' : 'border-transparent text-gray-500 hover:'"
                        class="py-2 px-1 border-b-2 font-medium text-sm transition">
                    {% trans "Brewing Method" %}
                </button>
                <button @click="activeTab = 'reviews'" 
                        :class="activeTab === 'reviews' ? 'border-amber-500 text-amber-600' : 'border-transparent text-gray-500 hover:'"
                        class="py-2 px-1 border-b-2 font-medium text-sm transition">
                    {% trans "Reviews" %} ({{ review_count }})
                </button>
            </nav>
        </div>
        
        <div class="mt-6">
            <!-- Description Tab -->
            <div x-show="activeTab === 'description'" class="prose max-w-none">
                {% if coffee.description %}
                <div class="">{{ coffee.description|linebreaks }}</div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-file-alt text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">{% trans "No description for this product" %}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Brewing Tab -->
            <div x-show="activeTab === 'brewing'" class="prose max-w-none">
                {% if coffee.brewing_method %}
                <div class="">{{ coffee.brewing_method|linebreaks }}</div>
                {% else %}
                <div class="bg-amber-50 p-6 rounded-lg">
                    <h4 class="font-semibold mb-4">{% trans "General brewing instructions for coffee" %}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="font-medium mb-2">{% trans "For Drip brewing" %}</h5>
                            <ul class="space-y-1  text-sm">
                                <li>‚Ä¢ {% trans "Ratio:" %} 1:15-1:17</li>
                                <li>‚Ä¢ {% trans "Temperature:" %} 90-95¬∞C</li>
                                <li>‚Ä¢ {% trans "Time:" %} 4-6 ‡∫ô‡∫≤‡∫ó‡∫µ</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-medium mb-2">{% trans "For Espresso" %}</h5>
                            <ul class="space-y-1  text-sm">
                                <li>‚Ä¢ ‡∫≠‡∫±‡∫î‡∫ï‡∫≤‡∫™‡ªà‡∫ß‡∫ô: 1:2</li>
                                <li>‚Ä¢ ‡∫≠‡∫∏‡∫ô‡∫´‡∫∞‡∫û‡∫π‡∫°: 90-96¬∞C</li>
                                <li>‚Ä¢ ‡ªÄ‡∫ß‡∫•‡∫≤: 25-30 {% trans "seconds" %}</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-amber-200">
                        <p class="text-sm ">
                            <i class="fas fa-lightbulb text-amber-500 mr-1"></i>
                            {% trans "Recommended to use good quality clean water and freshly ground coffee before brewing" %}
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Reviews Tab -->
            <div x-show="activeTab === 'reviews'">
                
                <!-- Add Review Form -->
                <div class="border border-amber-200 p-6 rounded-lg mb-8">
                    <h4 class="font-semibold mb-4">{% trans "Write a review" %}</h4>
                    <form method="POST" action="{% url 'add_review' coffee.slug %}" class="space-y-4">
                        {% csrf_token %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium  mb-2">{% trans "Your Name" %}</label>
                                <input type="text" name="reviewer_name" required
                                        placeholder="{% trans "Your Name..." %}"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium  mb-2">{% trans "Rating" %}</label>
                                <select name="rating" required
                                        class="w-full text-gray-400 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                    <option value="">{% trans "Select Rating" %}</option>
                                    <option value="5">{% trans "5 Stars - Excellent" %}</option>
                                    <option value="4">{% trans "4 Stars - Very Good" %}</option>
                                    <option value="3">{% trans "3 Stars - Good" %}</option>
                                    <option value="2">{% trans "2 Stars - Fair" %}</option>
                                    <option value="1">{% trans "1 Star - Poor" %}</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium  mb-2">{% trans "Comment" %}</label>
                            <textarea name="comment" rows="4" required
                                      placeholder="{% trans "Tell us about your experience drinking this coffee..." %}"
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"></textarea>
                        </div>
                        <button type="submit" 
                                class="bg-amber-600 px-6 py-2 text-white rounded-lg hover:bg-amber-700 transition">
                            {% trans "Submit Review" %}
                        </button>
                    </form>
                </div>
                
                <!-- Reviews List -->
                <div class="space-y-6">
                    {% for review in reviews %}
                    <div class="border-b border-gray-200 pb-6">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h5 class="font-semibold">{{ review.reviewer_name }}</h5>
                                <div class="flex items-center mt-1">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                        <i class="fas fa-star text-yellow-400 text-sm"></i>
                                        {% else %}
                                        <i class="far fa-star text-gray-300 text-sm"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="ml-2 text-sm ">{{ review.rating }}/5</span>
                                </div>
                            </div>
                            <span class="text-sm text-gray-500">{{ review.created_at|date:"d M Y" }}</span>
                        </div>
                        <p class="">{{ review.comment }}</p>
                    </div>
                    {% empty %}
                    <div class="text-center py-8">
                        <i class="fas fa-comments text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">{% trans "No reviews yet for this product" %}</p>
                        <p class=" text-sm">{% trans "Be the first to review!" %}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Similar Coffees -->
    {% if similar_coffees %}
    <div class="border-t border-gray-200 dark:border-gray-700 pt-12 mt-12">
        <div class="text-center mb-12">
            <div class="flex items-center justify-center mb-4">
                <div class="h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent flex-1"></div>
                <div class="px-6">
                    <i class="fas fa-coffee text-3xl text-amber-600 mb-2"></i>
                </div>
                <div class="h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent flex-1"></div>
            </div>
            <h3 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{% trans "Similar Coffees" %}</h3>
            <p class="text-gray-600 dark:text-gray-400">{% trans "Discover coffees with similar flavors" %}</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            {% for similar_coffee in similar_coffees %}
            <div class="group relative bg-white dark:bg-gray-800 rounded-2xl shadow-lg hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 overflow-hidden border border-gray-100 dark:border-gray-700">
                <!-- Product Badge -->
                <div class="absolute top-4 left-4 z-10">
                    <span class="bg-amber-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">
                        {% trans "Recommended" %}
                    </span>
                </div>

                <!-- Image Container -->
                <div class="relative h-64 bg-gradient-to-br from-amber-100 via-amber-200 to-amber-300 dark:from-amber-800 dark:via-amber-700 dark:to-amber-600 overflow-hidden">
                    {% if similar_coffee.images %}
                        <img src="{{ similar_coffee.images.url }}"
                             alt="{{ similar_coffee.name }}"
                             class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    {% else %}
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <i class="fas fa-coffee text-6xl text-amber-600 dark:text-amber-300 opacity-60 mb-2"></i>
                                <p class="text-amber-700 dark:text-amber-200 text-sm font-medium">{{ similar_coffee.name }}</p>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Overlay gradient -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </div>

                <!-- Content -->
                <div class="p-6">
                    <div class="mb-4">
                        <h4 class="font-bold text-lg text-gray-900 dark:text-white mb-2 line-clamp-2 group-hover:text-amber-600 transition-colors duration-300">
                            {{ similar_coffee.name }}
                        </h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 flex items-center">
                            <i class="fas fa-seedling mr-2 text-green-500"></i>
                            {{ similar_coffee.coffee_bean.name }}
                        </p>
                    </div>

                    <!-- Rating & Reviews -->
                    {% if similar_coffee.avg_rating %}
                    <div class="flex items-center mb-4">
                        <div class="flex items-center">
                            {% for i in "12345" %}
                                {% if forloop.counter <= similar_coffee.avg_rating %}
                                    <i class="fas fa-star text-yellow-400 text-sm"></i>
                                {% else %}
                                    <i class="far fa-star text-gray-300 text-sm"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">
                            ({{ similar_coffee.avg_rating|lao_intcomma }})
                        </span>
                    </div>
                    {% endif %}

                    <!-- Price & Action -->
                    <div class="flex items-center justify-between pt-4 border-t border-gray-100 dark:border-gray-700">
                        <div>
                            <span class="text-xl font-bold text-amber-600 dark:text-amber-400">
                                {{ similar_coffee.price|lao_currency }}
                            </span>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                {{ similar_coffee.weight }}{{ similar_coffee.weight_unit }}
                            </p>
                        </div>
                        <a href="{% url 'coffee_detail' similar_coffee.slug %}"
                           class="inline-flex items-center px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-sm font-medium rounded-lg transition-colors duration-300 transform hover:scale-105 shadow-md hover:shadow-lg">
                            <span>{% trans "View Details" %}</span>
                            <i class="fas fa-arrow-right ml-2"></i>
                        </a>
                    </div>
                </div>

                <!-- Hover effect background -->
                <div class="absolute inset-0 bg-gradient-to-r from-amber-400/0 via-amber-400/5 to-amber-400/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
            </div>
            {% endfor %}
        </div>

        <!-- View All Button -->
        <div class="text-center mt-12">
            <a href="{% url 'coffee_list' %}"
               class="inline-flex items-center px-8 py-3 bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white font-semibold rounded-full transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                <i class="fas fa-th-large mr-3"></i>
                {% trans "View All Coffee" %}   
                <i class="fas fa-arrow-right ml-3"></i>
            </a>
        </div>
    </div>
    {% endif %}
</div>
<script>
    // ========= Variant Selection + WhatsApp =========
    document.addEventListener('alpine:init', () => {
      Alpine.data('coffeeSelector', () => ({
        // server-provided variant index: { roast_id: { grind: {...} } }
        variantsIndex: {{ variants_index_json|default:"{}"|safe }},
    
        // initialize from current coffee
        selectedRoastId: {{ coffee.roast_level.id }},
        selectedGrind: '{{ coffee.grind_type }}',
    
        // derived
        get selectedVariant() {
          const r = this.selectedRoastId;
          const g = this.selectedGrind;
          return (this.variantsIndex[r] && this.variantsIndex[r][g]) ? this.variantsIndex[r][g] : null;
        },
    
        isGrindAvailable(grind) {
          const r = this.selectedRoastId;
          return !!(this.variantsIndex[r] && this.variantsIndex[r][grind]);
        },
    
        onRoastChange() {
          // If current grind isn't available for new roast, pick the first available grind
          if (!this.isGrindAvailable(this.selectedGrind)) {
            const map = this.variantsIndex[this.selectedRoastId] || {};
            const first = Object.keys(map)[0];
            this.selectedGrind = first || this.selectedGrind; // keep old if nothing exists
          }
        },
    
        onGrindChange() {
          // no-op, but kept for symmetry / future hooks
        },
    
        sendWhatsAppOrder() {
            const variant = this.selectedVariant;
            if (!variant) {
              showNotification('‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÑ‡∫ß‡ªâ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫¢‡∫π‡ªà! (No matching variant for your selection)', 'error');
              return;
            }
            const phoneNumber = '8562022133733';
            const message = `‡∫™‡∫∞‡∫ö‡∫≤‡∫ç‡∫î‡∫µ! ‡∫Ç‡ªâ‡∫≠‡∫ç‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫™‡∫±‡ªà‡∫á‡∫Å‡∫≤‡ªÄ‡∫ü:
          
          üì¶ ‡∫ú‡∫∞‡∫•‡∫¥‡∫î‡∫ï‡∫∞‡∫û‡∫±‡∫ô: ${variant.name}
          üî• ‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªà‡∫ß: ${variant.roast_label}
          ü´ò ‡ªÅ‡∫ö‡∫ö‡ªÄ‡∫°‡∫±‡∫î/‡∫ö‡∫ª‡∫î: ${variant.grind_type}
          üí∞ ‡∫•‡∫≤‡∫Ñ‡∫≤: ${variant.price.toLocaleString()} LAK
          ‚öñÔ∏è ‡∫ô‡ªâ‡∫≥‡ªú‡∫±‡∫Å: ${variant.weight}
          üîó ‡∫•‡∫¥‡ªâ‡∫á: ${window.location.origin}/coffee/${variant.slug}/
          
          ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÅ‡∫à‡ªâ‡∫á‡∫ß‡∫¥‡∫ó‡∫µ‡∫à‡∫±‡∫î‡∫™‡∫ª‡ªà‡∫á ‡ªÅ‡∫•‡∫∞ ‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞‡ªÄ‡∫á‡∫¥‡∫ô
          ‡∫Ç‡∫≠‡∫ö‡ªÉ‡∫à!`;
          
            const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
          
            // Try opening in a new tab; if blocked, fall back to same-tab navigation
            const win = window.open(url, '_blank');
            if (!win) window.location.href = url;
          },
      }));
    });
</script>
    

<script>
// Alpine.js Image Gallery Component - Taobao Style
function imageGallery() {
    const images = [
        {% if coffee.images %}'{{ coffee.images.url }}'{% endif %}
        {% for gallery_image in coffee.gallery_images.all %}
        {% if coffee.images %},{% endif %}'{{ gallery_image.image.url }}'
        {% endfor %}
    ].filter(img => img); // Remove empty strings

    return {
        activeImage: images[0] || null,
        images: images,
        currentImageIndex: 0,
        totalImages: images.length,
        scrollOffset: 0,
        maxVisibleThumbnails: 5, // Number of visible thumbnails (384px / 68px)

        // Computed properties for scroll buttons
        get canScrollUp() {
            return this.scrollOffset > 0;
        },

        get canScrollDown() {
            return this.scrollOffset < Math.max(0, this.totalImages - this.maxVisibleThumbnails);
        },

        setActiveImage(imageUrl, index) {
            this.activeImage = imageUrl;
            this.currentImageIndex = index !== undefined ? index : this.images.indexOf(imageUrl);

            // Auto-scroll thumbnails to keep active image visible
            this.autoScrollToActive();
        },


        nextImage() {
            if (this.currentImageIndex < this.images.length - 1) {
                this.currentImageIndex++;
            } else {
                this.currentImageIndex = 0; // Loop back to first image
            }
            this.activeImage = this.images[this.currentImageIndex];
            this.autoScrollToActive();
        },

        previousImage() {
            if (this.currentImageIndex > 0) {
                this.currentImageIndex--;
            } else {
                this.currentImageIndex = this.images.length - 1; // Loop to last image
            }
            this.activeImage = this.images[this.currentImageIndex];
            this.autoScrollToActive();
        },

        scrollUp() {
            if (this.canScrollUp) {
                this.scrollOffset = Math.max(0, this.scrollOffset - 1);
            }
        },

        scrollDown() {
            if (this.canScrollDown) {
                this.scrollOffset = Math.min(
                    Math.max(0, this.totalImages - this.maxVisibleThumbnails),
                    this.scrollOffset + 1
                );
            }
        },

        autoScrollToActive() {
            const activeIndex = this.currentImageIndex;

            // If active image is above visible area, scroll up
            if (activeIndex < this.scrollOffset) {
                this.scrollOffset = activeIndex;
            }
            // If active image is below visible area, scroll down
            else if (activeIndex >= this.scrollOffset + this.maxVisibleThumbnails) {
                this.scrollOffset = Math.max(0, activeIndex - this.maxVisibleThumbnails + 1);
            }
        },

        // Smooth wheel scrolling for thumbnails
        handleWheel(event) {
            event.preventDefault();
            if (event.deltaY > 0) {
                this.scrollDown();
            } else {
                this.scrollUp();
            }
        },

        // Initialize on component mount
        init() {
            console.log('Taobao-style gallery initialized with', this.totalImages, 'images');

            // Add wheel event listener to thumbnail container
            this.$nextTick(() => {
                const container = document.getElementById('thumbnail-container');
                if (container) {
                    container.parentElement.addEventListener('wheel', (e) => this.handleWheel(e));
                }
            });
        }
    };
}

// WhatsApp Order functionality
function orderViaWhatsApp(coffeeName, price, weight) {
    // WhatsApp business number (replace with actual number)
    const phoneNumber = '8562022133733'; // Your WhatsApp business number

    // Create order message
    const message = `‡∫™‡∫∞‡∫ö‡∫≤‡∫ç‡∫î‡∫µ! ‡∫Ç‡ªâ‡∫≠‡∫ç‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫™‡∫±‡ªà‡∫á‡∫Å‡∫≤‡ªÄ‡∫ü:

üì¶ ‡∫ú‡∫∞‡∫•‡∫¥‡∫î‡∫ï‡∫∞‡∫û‡∫±‡∫ô: ${coffeeName}
üí∞ ‡∫•‡∫≤‡∫Ñ‡∫≤: ${price} LAK
‚öñÔ∏è ‡∫ô‡ªâ‡∫≥‡ªú‡∫±‡∫Å: ${weight}
üîó ‡∫•‡∫¥‡ªâ‡∫á: ${window.location.href}

‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÅ‡∫à‡ªâ‡∫á‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫Å‡∫≤‡∫ô‡∫à‡∫±‡∫î‡∫™‡∫ª‡ªà‡∫á ‡ªÅ‡∫•‡∫∞ ‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞‡ªÄ‡∫á‡∫¥‡∫ô

‡∫Ç‡∫≠‡∫ö‡ªÉ‡∫à!`;

    // Create WhatsApp URL
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;

    // Open WhatsApp in new window/tab
    window.open(whatsappUrl, '_blank');

    // Track order attempt (optional analytics)
    console.log('WhatsApp order initiated for:', coffeeName);
}

// Add to wishlist functionality
function addToWishlist(coffeeSlug) {
    // Get existing wishlist from localStorage
    let wishlist = JSON.parse(localStorage.getItem('coffee_wishlist') || '[]');

    // Check if already in wishlist
    if (wishlist.includes(coffeeSlug)) {
        // Remove from wishlist
        wishlist = wishlist.filter(slug => slug !== coffeeSlug);
        localStorage.setItem('coffee_wishlist', JSON.stringify(wishlist));

        // Update button appearance
        const button = event.target.closest('button');
        const icon = button.querySelector('i');
        const text = button.querySelector('span');

        icon.className = 'fas fa-heart text-sm';
        text.textContent = '‡∫ñ‡∫∑‡∫Å‡ªÉ‡∫à';
        button.className = button.className.replace('bg-amber-500 text-white', 'border-2 border-amber-500 text-amber-600 hover:bg-amber-500 hover:text-white');

        // Show notification
        showNotification('‡∫•‡∫∂‡∫ö‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ó‡∫µ‡ªà‡∫ñ‡∫∑‡∫Å‡ªÉ‡∫à‡ªÅ‡∫•‡ªâ‡∫ß', 'info');
    } else {
        // Add to wishlist
        wishlist.push(coffeeSlug);
        localStorage.setItem('coffee_wishlist', JSON.stringify(wishlist));

        // Update button appearance
        const button = event.target.closest('button');
        const icon = button.querySelector('i');
        const text = button.querySelector('span');

        icon.className = 'fas fa-heart text-sm text-red-500';
        text.textContent = '‡∫ñ‡∫∑‡∫Å‡ªÉ‡∫à‡ªÅ‡∫•‡ªâ‡∫ß';
        button.className = button.className.replace('border-2 border-amber-500 text-amber-600 hover:bg-amber-500 hover:text-white', 'bg-amber-500 text-white');

        // Show notification
        showNotification('‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÉ‡∫™‡ªà‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ó‡∫µ‡ªà‡∫ñ‡∫∑‡∫Å‡ªÉ‡∫à‡ªÅ‡∫•‡ªâ‡∫ß', 'success');
    }
}

// Show notification function
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;

    // Add to document
    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);

    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Check wishlist status on page load
document.addEventListener('DOMContentLoaded', function() {
    const wishlist = JSON.parse(localStorage.getItem('coffee_wishlist') || '[]');
    const coffeeSlug = '{{ coffee.slug }}';

    if (wishlist.includes(coffeeSlug)) {
        // Update wishlist button to show it's already liked
        const wishlistButton = document.querySelector('[onclick*="addToWishlist"]');
        if (wishlistButton) {
            const icon = wishlistButton.querySelector('i');
            const text = wishlistButton.querySelector('span');

            icon.className = 'fas fa-heart text-sm text-red-500';
            text.textContent = '‡∫ñ‡∫∑‡∫Å‡ªÉ‡∫à‡ªÅ‡∫•‡ªâ‡∫ß';
            wishlistButton.className = wishlistButton.className.replace('border-2 border-amber-500 text-amber-600 hover:bg-amber-500 hover:text-white', 'bg-amber-500 text-white');
        }
    }
});

// Share functionality
function shareProduct() {
    if (navigator.share) {
        navigator.share({
            title: '{{ coffee.name }}',
            text: '{{ coffee.description|truncatewords:20|default:"Check out this coffee!" }}',
            url: window.location.href
        }).catch(console.error);
    } else {
        // Fallback to copying URL
        navigator.clipboard.writeText(window.location.href).then(() => {
            showNotification('‡∫•‡∫¥‡ªâ‡∫á‡ªÑ‡∫î‡ªâ‡∫ñ‡∫∑‡∫Å‡∫Ñ‡∫±‡∫î‡∫•‡∫≠‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß!', 'success');
        }).catch(() => {
            showNotification('‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫Ñ‡∫±‡∫î‡∫•‡∫≠‡∫Å‡∫•‡∫¥‡ªâ‡∫á‡ªÑ‡∫î‡ªâ', 'error');
        });
    }
}

// Compare functionality placeholder
function toggleCompare(coffeeId) {
    console.log('Toggle compare for coffee:', coffeeId);
    // Implement your compare logic here
}

</script>

{% endblock %}
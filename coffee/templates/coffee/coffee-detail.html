{% extends 'base.html' %}

{% load i18n %}

{% load lao_filters %}

{% load coffee_filters %}

{% block title %}{{ coffee.name }}{% endblock %}

{% block extra_css %}
<style>
    .scrollbar-hide {
        -ms-overflow-style: none;  /* Internet Explorer 10+ */
        scrollbar-width: none;  /* Firefox */
    }
    .scrollbar-hide::-webkit-scrollbar {
        display: none;  /* Safari and Chrome */
    }

    /* Optional: Add smooth scroll behavior for better UX */
    .scrollbar-hide {
        scroll-behavior: smooth;
    }

    /* Hide volume controls and other video controls */
    #main-video::-webkit-media-controls-volume-slider,
    #main-video::-webkit-media-controls-mute-button {
        display: none !important;
    }

    /* Hide fullscreen button */
    #main-video::-webkit-media-controls-fullscreen-button {
        display: none !important;
    }

    /* Hide playback rate */
    #main-video::-webkit-media-controls-overflow-button {
        display: none !important;
    }

    /* Hide timeline/seek bar and current time display */
    #main-video::-webkit-media-controls-timeline,
    #main-video::-webkit-media-controls-current-time-display,
    #main-video::-webkit-media-controls-time-remaining-display {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-8">
        <ol class="flex items-center space-x-2 text-sm">
            <li><a href="{% url 'coffee_list' %}" class="text-amber-600 hover:text-amber-700">{% trans "All Coffee" %}</a></li>
            <li class="">/</li>
            {% if coffee.categories.exists %}
                {% with first_category=coffee.categories.first %}
                <li><a href="{% url 'category' first_category.id %}" class="text-amber-600 hover:text-amber-700">{{ first_category.name }}</a></li>
                {% endwith %}
            {% else %}
                <li class="text-gray-500">{% trans "Coffee Category" %}</li>
            {% endif %}
            <li class="">/</li>
            <li class="">{{ coffee.name }}</li>
        </ol>
    </nav>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-12">
        
        <!-- Taobao-style Image Gallery -->
        <div class="flex space-x-4 p-4">
            <!-- Vertical Thumbnail Gallery (Left Side) - Taobao Style -->
            <div class="relative flex-shrink-0" id="thumbnail-section">
                <!-- Thumbnail container with smooth scroll - Taobao Style -->
                <div class="relative h-[420px] w-[68px] overflow-hidden">
                    <div class="flex flex-col space-y-2 p-1 transition-transform duration-300 ease-out scrollbar-hide"
                         id="thumbnail-container">
                        <!-- Main product image thumbnail -->
                        {% if coffee.images %}
                        <div class="flex-shrink-0 aspect-square w-[60px] h-[60px] bg-white border-2 border-amber-500 shadow-md ring-2 ring-amber-100 rounded-md cursor-pointer overflow-hidden group relative active-thumbnail transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg hover:border-amber-400"
                             data-image="{{ coffee.images.url }}"
                             onclick="setActiveImage('{{ coffee.images.url }}', this)"
                             onmouseenter="setActiveImage('{{ coffee.images.url }}', this)">
                            <img src="{{ coffee.images.url }}"
                                 alt="{{ coffee.name }}"
                                 class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200">
                            <!-- Active indicator -->
                            <div class="absolute -top-1 -right-1 w-4 h-4 bg-amber-500 rounded-full flex items-center justify-center shadow-md active-indicator">
                                <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <!-- Hover overlay -->
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all duration-200"></div>
                        </div>
                        {% endif %}

                        <!-- Gallery images thumbnails -->
                        {% for gallery_image in coffee.gallery_images.all %}
                        <div class="flex-shrink-0 aspect-square w-[60px] h-[60px] bg-white border-2 border-gray-200 rounded-md cursor-pointer overflow-hidden group relative transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg hover:border-amber-400"
                             data-image="{{ gallery_image.image.url }}"
                             onclick="setActiveImage('{{ gallery_image.image.url }}', this)"
                             onmouseenter="setActiveImage('{{ gallery_image.image.url }}', this)">
                            <img src="{{ gallery_image.image.url }}"
                                 alt="{{ gallery_image.alt_text|default:coffee.name }}"
                                 class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200">
                            <!-- Active indicator (hidden by default) -->
                            <div class="absolute -top-1 -right-1 w-4 h-4 bg-amber-500 rounded-full flex items-center justify-center shadow-md active-indicator" style="display: none;">
                                <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <!-- Hover overlay -->
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all duration-200"></div>
                        </div>
                        {% endfor %}

                        <!-- Product video thumbnail (if exists) -->
                        {% if coffee.video %}
                        <div class="flex-shrink-0 aspect-square w-[60px] h-[60px] bg-white border-2 border-gray-200 rounded-md cursor-pointer overflow-hidden group relative transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg hover:border-amber-400"
                             data-video="{{ coffee.video.url }}"
                             data-type="video"
                             onclick="setActiveVideo('{{ coffee.video.url }}', this)"
                             onmouseenter="setActiveVideo('{{ coffee.video.url }}', this)">
                            <!-- Video preview thumbnail -->
                            <video class="w-full h-full object-cover" muted>
                                <source src="{{ coffee.video.url }}" type="video/mp4">
                            </video>
                            <!-- Video play icon overlay -->
                            <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30">
                                <i class="fas fa-play-circle text-white text-2xl"></i>
                            </div>
                            <!-- Active indicator (hidden by default) -->
                            <div class="absolute -top-1 -right-1 w-4 h-4 bg-amber-500 rounded-full flex items-center justify-center shadow-md active-indicator" style="display: none;">
                                <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <!-- Hover overlay -->
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all duration-200"></div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Scroll buttons -->
                <button id="scroll-up-btn"
                        class="absolute -top-2 left-1/2 transform -translate-x-1/2 bg-white shadow-lg border border-gray-200 rounded-full w-7 h-7 flex items-center justify-center hover:bg-amber-50 hover:border-amber-300 hover:shadow-xl transition-all duration-200 z-10"
                        style="display: none;"
                        onclick="scrollThumbnailsUp()">
                    <i class="fas fa-chevron-up text-gray-600 text-xs"></i>
                </button>

                <button id="scroll-down-btn"
                        class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-white shadow-lg border border-gray-200 rounded-full w-7 h-7 flex items-center justify-center hover:bg-amber-50 hover:border-amber-300 hover:shadow-xl transition-all duration-200 z-10"
                        style="display: none;"
                        onclick="scrollThumbnailsDown()">
                    <i class="fas fa-chevron-down text-gray-600 text-xs"></i>
                </button>
            </div>

            <!-- Main Image Display -->
            <div class="flex-1 relative group">
                <div id="main-media-container" class="aspect-square bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm flex items-center justify-center relative overflow-hidden hover:shadow-lg transition-all duration-300">
                    <!-- Main image -->
                    <img id="main-image"
                         src="{% if coffee.images %}{{ coffee.images.url }}{% else %}#{% endif %}"
                         alt="{{ coffee.name }}"
                         class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">

                    <!-- Main video (initially hidden) -->
                    <video id="main-video"
                           src=""
                           controls
                           controlsList="nodownload noplaybackrate nofullscreen"
                           disablePictureInPicture
                           class="w-full h-full object-contain absolute inset-0 hidden bg-black"
                           style="pointer-events: auto;"></video>

                    <!-- Fallback when no image -->
                    {% if not coffee.images and not coffee.gallery_images.all %}
                    <div class="flex flex-col items-center justify-center text-gray-300">
                        <i class="fas fa-coffee text-8xl"></i>
                        <p class="text-xs mt-2">No image available</p>
                    </div>
                    {% endif %}

                    <!-- Navigation arrows -->
                    <div class="absolute inset-y-0 left-0 right-0 flex items-center justify-between p-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <button onclick="previousImage()"
                                class="bg-white/90 backdrop-blur-sm text-gray-600 rounded-full w-10 h-10 flex items-center justify-center hover:bg-white hover:text-amber-600 hover:shadow-lg transition-all duration-200 border border-gray-200">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="nextImage()"
                                class="bg-white/90 backdrop-blur-sm text-gray-600 rounded-full w-10 h-10 flex items-center justify-center hover:bg-white hover:text-amber-600 hover:shadow-lg transition-all duration-200 border border-gray-200">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Image counter -->
                    <div id="image-counter" class="absolute bottom-4 right-4 bg-black/70 backdrop-blur-sm text-white px-3 py-1.5 rounded-full text-sm font-medium"
                         style="display: none;">
                        <span id="current-index">1</span>/<span id="total-images">1</span>
                    </div>

                    <!-- Product badges -->
                    <div class="absolute top-4 left-4 space-y-2">
                        {% if coffee.is_fresh %}
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-1.5 rounded-full text-xs font-semibold shadow-lg flex items-center space-x-1">
                            <i class="fas fa-leaf"></i>
                            <span>{% trans "Fresh" %}</span>
                        </div>
                        {% endif %}

                        {% if coffee.stock_quantity < 10 and coffee.stock_quantity > 0 %}
                        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-1.5 rounded-full text-xs font-semibold shadow-lg flex items-center space-x-1">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>{% trans "Low Stock" %}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Rating Badge -->
                    {% if avg_rating > 0 %}
                    <div class="absolute top-4 right-4 bg-yellow-400 text-yellow-900 px-3 py-1.5 rounded-full text-xs font-semibold shadow-lg">
                        <i class="fas fa-star mr-1"></i>{{ avg_rating|floatformat:1 }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Coffee Details -->
        <div class="space-y-6" x-data="coffeeSelector()">
            <div>
                <h1 class="text-3xl font-bold mb-2">{{ coffee.name }}</h1>
                <p class="text-lg">{{ coffee.coffee_bean.name }} ({{ coffee.coffee_bean.get_origin_display }})</p>
            </div>
            
            <!-- Rating -->
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    {% for i in "12345" %}
                        {% if forloop.counter <= avg_rating %}
                        <i class="fas fa-star text-yellow-400"></i>
                        {% else %}
                        <i class="far fa-star text-gray-300"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="">{{ avg_rating|floatformat:1 }}/5.0 ({% blocktrans count review_count=review_count %}{{ review_count }} review{% plural %}{{ review_count }} reviews{% endblocktrans %})</span>
            </div>
            
            <!-- Price -->
            <div class="border-t border-gray-200 pt-6">
                <div class="flex items-baseline space-x-4">
                    <span class="text-4xl font-bold text-amber-600">{{ coffee.price|lao_currency }}</span>
                    <span class="text-gray-500">{{ coffee.weight }}{{ coffee.weight_unit }}</span>
                </div>
                <p class="text-sm text-gray-500 mt-1">{{ coffee.price_per_unit|lao_currency }}/100g</p>
            </div>
            
            <!-- Select Roast (Radio) -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold mb-4">{% trans "Roasting Type" %}</h3>
                <fieldset class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                {% for roast in available_roasts %}
                    <label class="flex items-center gap-3 px-4 py-2 border text-amber-600 rounded-lg cursor-pointer transition
                                hover:border-amber-400"
                        :class="selectedRoastId == {{ roast.id }} ? 'bg-amber-50 border-amber-500 ring-1 ring-amber-200' : 'border-gray-300'">
                    <input type="radio"
                            name="roast"
                            value="{{ roast.id }}"
                            class="h-4 w-4 text-amber-600 focus:ring-amber-500"
                            x-model="selectedRoastId"
                            @change="onRoastChange()"
                            {% if roast.id == coffee.roast_level.id %}checked{% endif %}>
                    <span class="font-medium">{{ roast.get_name_display }}</span>
                    </label>
                {% endfor %}
                </fieldset>
            </div>
  
            <!-- Select Grind (Radio) -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold mb-4">{% trans "Beans" %}</h3>
                <fieldset class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                {% for grind in available_grinds %}
                    {# We'll enable/disable these via Alpine based on selected roast + variants_index #}
                    <label class="flex items-center gap-3 px-4 py-2 border text-amber-600 rounded-lg cursor-pointer transition"
                        :class="isGrindAvailable('{{ grind }}') ? 
                                (selectedGrind == '{{ grind }}' ? 'bg-amber-50 border-amber-500 ring-1 ring-amber-200' : 'border-gray-300 hover:border-amber-400') :
                                'border-gray-200 opacity-50 cursor-not-allowed'">
                    <input type="radio"
                            name="grind"
                            value="{{ grind }}"
                            class="h-4 w-4 text-amber-600 focus:ring-amber-500"
                            x-model="selectedGrind"
                            :disabled="!isGrindAvailable('{{ grind }}')"
                            @change="onGrindChange()"
                            {% if grind == coffee.grind_type %}checked{% endif %}>
                    <span class="font-medium">{{ grind|capfirst }}</span>
                    </label>
                {% endfor %}
                </fieldset>
            </div>

            
            <!-- Categories -->
            {% if coffee.categories.exists %}
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold mb-4">{% trans "Categories" %}</h3>
                <div class="flex flex-wrap gap-2">
                    {% for category in coffee.categories.all %}
                    <span class="bg-amber-100 text-amber-600 px-3 py-1 rounded-full text-sm">
                        {{ category.name }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Flavor Profile -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold mb-4">{% trans "Flavor and Aroma" %}</h3>
                {% if coffee.coffee_bean.flavor_notes %}
                <p class=" mb-4">{{ coffee.coffee_bean.flavor_notes }}</p>
                {% endif %}
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class=" text-sm">{% trans "Acidity" %}</span>
                        <div class="flex items-center mt-1">
                            {% for i in "12345" %}
                                {% if forloop.counter <= coffee.coffee_bean.acidity_level %}
                                <div class="w-4 h-4 bg-amber-400 rounded-full mr-1"></div>
                                {% else %}
                                <div class="w-4 h-4 bg-gray-200 rounded-full mr-1"></div>
                                {% endif %}
                            {% endfor %}
                            <span class="ml-2 text-sm ">{{ coffee.coffee_bean.acidity_level }}/5</span>
                        </div>
                    </div>
                    <div>
                        <span class=" text-sm">{% trans "Body" %}</span>
                        <div class="flex items-center mt-1">
                            {% for i in "12345" %}
                                {% if forloop.counter <= coffee.coffee_bean.body_level %}
                                <div class="w-4 h-4 bg-amber-600 rounded-full mr-1"></div>
                                {% else %}
                                <div class="w-4 h-4 bg-gray-200 rounded-full mr-1"></div>
                                {% endif %}
                            {% endfor %}
                            <span class="ml-2 text-sm ">{{ coffee.coffee_bean.body_level }}/5</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="border-t border-gray-200 pt-6 space-y-4">
                <!-- WhatsApp Order Button -->
                <div class="space-y-3">
                    <!-- Order via WhatsApp (uses selected variant) -->
                        <button @click="sendWhatsAppOrder()"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg transform hover:scale-105">
                        <i class="fab fa-whatsapp text-xl"></i>
                        <span>{% trans "Order via WhatsApp" %}</span>
                        </button>


                    <!-- Secondary action buttons -->
                    <div class="grid grid-cols-2 gap-3">
                        <button class="flex items-center justify-center space-x-2 border-2 border-amber-500 text-amber-600 hover:bg-amber-500 hover:text-white font-medium py-2 px-4 rounded-lg transition-all duration-200"
                                onclick="addToWishlist('{{ coffee.slug }}')">
                            <i class="fas fa-heart text-sm"></i>
                            <span>{% trans "Like" %}</span>
                        </button>

                        <button class="flex items-center justify-center space-x-2 border-2 border-gray-300 text-gray-600 hover:bg-gray-100 font-medium py-2 px-4 rounded-lg transition-all duration-200"
                                onclick="shareProduct()">
                            <i class="fas fa-share-alt text-sm"></i>
                            <span>{% trans "Share" %}</span>
                        </button>
                    </div>
                </div>

                <!-- Stock Status -->
                <div class="flex items-center space-x-2 text-sm">
                    {% if coffee.stock_quantity > 0 %}
                        <div class="flex items-center text-green-600">
                            <i class="fas fa-check-circle mr-1"></i>
                            <span>{% trans "In Stock" %} ({{ coffee.stock_quantity }} {% trans "bags" %})</span>
                        </div>
                    {% else %}
                        <div class="flex items-center text-red-600">
                            <i class="fas fa-times-circle mr-1"></i>
                            <span>{% trans "Out of Stock" %}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabs -->
    <div x-data="{ activeTab: 'description' }" class="mb-12">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8">
                <button @click="activeTab = 'description'" 
                        :class="activeTab === 'description' ? 'border-amber-500 text-amber-600' : 'border-transparent text-gray-500 hover:'"
                        class="py-2 px-1 border-b-2 font-medium text-sm transition">
                    {% trans "Description" %}
                </button>
                <button @click="activeTab = 'brewing'" 
                        :class="activeTab === 'brewing' ? 'border-amber-500 text-amber-600' : 'border-transparent text-gray-500 hover:'"
                        class="py-2 px-1 border-b-2 font-medium text-sm transition">
                    {% trans "Brewing Method" %}
                </button>
                <button @click="activeTab = 'reviews'" 
                        :class="activeTab === 'reviews' ? 'border-amber-500 text-amber-600' : 'border-transparent text-gray-500 hover:'"
                        class="py-2 px-1 border-b-2 font-medium text-sm transition">
                    {% trans "Reviews" %} ({{ review_count }})
                </button>
            </nav>
        </div>
        
        <div class="mt-6">
            <!-- Description Tab -->
            <div x-show="activeTab === 'description'" class="prose max-w-none">
                {% if coffee.description %}
                <div class="">{{ coffee.description|linebreaks }}</div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-file-alt text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">{% trans "No description for this product" %}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Brewing Tab -->
            <div x-show="activeTab === 'brewing'" class="prose max-w-none">
                {% if coffee.brewing_method %}
                <div class="">{{ coffee.brewing_method|linebreaks }}</div>
                {% else %}
                <div class="bg-amber-50 p-6 rounded-lg">
                    <h4 class="font-semibold mb-4">{% trans "General brewing instructions for coffee" %}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="font-medium mb-2">{% trans "For Drip brewing" %}</h5>
                            <ul class="space-y-1  text-sm">
                                <li>• {% trans "Ratio:" %} 1:15-1:17</li>
                                <li>• {% trans "Temperature:" %} 90-95°C</li>
                                <li>• {% trans "Time:" %} 4-6 ນາທີ</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-medium mb-2">{% trans "For Espresso" %}</h5>
                            <ul class="space-y-1  text-sm">
                                <li>• ອັດຕາສ່ວນ: 1:2</li>
                                <li>• ອຸນຫະພູມ: 90-96°C</li>
                                <li>• ເວລາ: 25-30 {% trans "seconds" %}</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-amber-200">
                        <p class="text-sm ">
                            <i class="fas fa-lightbulb text-amber-500 mr-1"></i>
                            {% trans "Recommended to use good quality clean water and freshly ground coffee before brewing" %}
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Reviews Tab -->
            <div x-show="activeTab === 'reviews'">
                
                <!-- Add Review Form -->
                <div class="border border-amber-200 p-6 rounded-lg mb-8">
                    <h4 class="font-semibold mb-4">{% trans "Write a review" %}</h4>
                    <form method="POST" action="{% url 'add_review' coffee.slug %}" class="space-y-4">
                        {% csrf_token %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium  mb-2">{% trans "Your Name" %}</label>
                                <input type="text" name="reviewer_name" required
                                        placeholder="{% trans "Your Name..." %}"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium  mb-2">{% trans "Rating" %}</label>
                                <select name="rating" required
                                        class="w-full text-gray-400 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                    <option value="">{% trans "Select Rating" %}</option>
                                    <option value="5">{% trans "5 Stars - Excellent" %}</option>
                                    <option value="4">{% trans "4 Stars - Very Good" %}</option>
                                    <option value="3">{% trans "3 Stars - Good" %}</option>
                                    <option value="2">{% trans "2 Stars - Fair" %}</option>
                                    <option value="1">{% trans "1 Star - Poor" %}</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium  mb-2">{% trans "Comment" %}</label>
                            <textarea name="comment" rows="4" required
                                      placeholder="{% trans "Tell us about your experience drinking this coffee..." %}"
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"></textarea>
                        </div>
                        <button type="submit" 
                                class="bg-amber-600 px-6 py-2 text-white rounded-lg hover:bg-amber-700 transition">
                            {% trans "Submit Review" %}
                        </button>
                    </form>
                </div>
                
                <!-- Reviews List -->
                <div class="space-y-6">
                    {% for review in reviews %}
                    <div class="border-b border-gray-200 pb-6">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h5 class="font-semibold">{{ review.reviewer_name }}</h5>
                                <div class="flex items-center mt-1">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                        <i class="fas fa-star text-yellow-400 text-sm"></i>
                                        {% else %}
                                        <i class="far fa-star text-gray-300 text-sm"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="ml-2 text-sm ">{{ review.rating }}/5</span>
                                </div>
                            </div>
                            <span class="text-sm text-gray-500">{{ review.created_at|date:"d M Y" }}</span>
                        </div>
                        <p class="">{{ review.comment }}</p>
                    </div>
                    {% empty %}
                    <div class="text-center py-8">
                        <i class="fas fa-comments text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">{% trans "No reviews yet for this product" %}</p>
                        <p class=" text-sm">{% trans "Be the first to review!" %}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Similar Coffees -->
    {% if similar_coffees %}
    <div class="border-t border-gray-200 dark:border-gray-700 pt-12 mt-12">
        <div class="text-center mb-12">
            <div class="flex items-center justify-center mb-4">
                <div class="h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent flex-1"></div>
                <div class="px-6">
                    <i class="fas fa-coffee text-3xl text-amber-600 mb-2"></i>
                </div>
                <div class="h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent flex-1"></div>
            </div>
            <h3 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{% trans "Similar Coffees" %}</h3>
            <p class="text-gray-600 dark:text-gray-400">{% trans "Discover coffees with similar flavors" %}</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            {% for similar_coffee in similar_coffees %}
            <div class="group relative bg-white dark:bg-gray-800 rounded-2xl shadow-lg hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 overflow-hidden border border-gray-100 dark:border-gray-700">
                <!-- Product Badge -->
                <div class="absolute top-4 left-4 z-10">
                    <span class="bg-amber-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">
                        {% trans "Recommended" %}
                    </span>
                </div>

                <!-- Image Container -->
                <div class="relative h-64 bg-gradient-to-br from-amber-100 via-amber-200 to-amber-300 dark:from-amber-800 dark:via-amber-700 dark:to-amber-600 overflow-hidden">
                    {% if similar_coffee.images %}
                        <img src="{{ similar_coffee.images.url }}"
                             alt="{{ similar_coffee.name }}"
                             class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    {% else %}
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <i class="fas fa-coffee text-6xl text-amber-600 dark:text-amber-300 opacity-60 mb-2"></i>
                                <p class="text-amber-700 dark:text-amber-200 text-sm font-medium">{{ similar_coffee.name }}</p>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Overlay gradient -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </div>

                <!-- Content -->
                <div class="p-6">
                    <div class="mb-4">
                        <h4 class="font-bold text-lg text-gray-900 dark:text-white mb-2 line-clamp-2 group-hover:text-amber-600 transition-colors duration-300">
                            {{ similar_coffee.name }}
                        </h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 flex items-center">
                            <i class="fas fa-seedling mr-2 text-green-500"></i>
                            {{ similar_coffee.coffee_bean.name }}
                        </p>
                    </div>

                    <!-- Rating & Reviews -->
                    {% if similar_coffee.avg_rating %}
                    <div class="flex items-center mb-4">
                        <div class="flex items-center">
                            {% for i in "12345" %}
                                {% if forloop.counter <= similar_coffee.avg_rating %}
                                    <i class="fas fa-star text-yellow-400 text-sm"></i>
                                {% else %}
                                    <i class="far fa-star text-gray-300 text-sm"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">
                            ({{ similar_coffee.avg_rating|lao_intcomma }})
                        </span>
                    </div>
                    {% endif %}

                    <!-- Price & Action -->
                    <div class="flex items-center justify-between pt-4 border-t border-gray-100 dark:border-gray-700">
                        <div>
                            <span class="text-xl font-bold text-amber-600 dark:text-amber-400">
                                {{ similar_coffee.price|lao_currency }}
                            </span>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                {{ similar_coffee.weight }}{{ similar_coffee.weight_unit }}
                            </p>
                        </div>
                        <a href="{% url 'coffee_detail' similar_coffee.slug %}"
                           class="inline-flex items-center px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-sm font-medium rounded-lg transition-colors duration-300 transform hover:scale-105 shadow-md hover:shadow-lg">
                            <span>{% trans "View Details" %}</span>
                            <i class="fas fa-arrow-right ml-2"></i>
                        </a>
                    </div>
                </div>

                <!-- Hover effect background -->
                <div class="absolute inset-0 bg-gradient-to-r from-amber-400/0 via-amber-400/5 to-amber-400/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
            </div>
            {% endfor %}
        </div>

        <!-- View All Button -->
        <div class="text-center mt-12">
            <a href="{% url 'coffee_list' %}"
               class="inline-flex items-center px-8 py-3 bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white font-semibold rounded-full transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                <i class="fas fa-th-large mr-3"></i>
                {% trans "View All Coffee" %}   
                <i class="fas fa-arrow-right ml-3"></i>
            </a>
        </div>
    </div>
    {% endif %}
</div>
<script>
    // ========= Variant Selection + WhatsApp =========
    document.addEventListener('alpine:init', () => {
      Alpine.data('coffeeSelector', () => ({
        // server-provided variant index: { roast_id: { grind: {...} } }
        variantsIndex: {{ variants_index_json|default:"{}"|safe }},
    
        // initialize from current coffee
        selectedRoastId: {{ coffee.roast_level.id }},
        selectedGrind: '{{ coffee.grind_type }}',
    
        // derived
        get selectedVariant() {
          const r = this.selectedRoastId;
          const g = this.selectedGrind;
          return (this.variantsIndex[r] && this.variantsIndex[r][g]) ? this.variantsIndex[r][g] : null;
        },
    
        isGrindAvailable(grind) {
          const r = this.selectedRoastId;
          return !!(this.variantsIndex[r] && this.variantsIndex[r][grind]);
        },
    
        onRoastChange() {
          // If current grind isn't available for new roast, pick the first available grind
          if (!this.isGrindAvailable(this.selectedGrind)) {
            const map = this.variantsIndex[this.selectedRoastId] || {};
            const first = Object.keys(map)[0];
            this.selectedGrind = first || this.selectedGrind; // keep old if nothing exists
          }
        },
    
        onGrindChange() {
          // no-op, but kept for symmetry / future hooks
        },
    
        sendWhatsAppOrder() {
            const variant = this.selectedVariant;
            if (!variant) {
              showNotification('ສິນຄ້າເລືອກໄວ້ບໍ່ມີຢູ່! (No matching variant for your selection)', 'error');
              return;
            }
            const phoneNumber = '8562022133733';
            const message = `ສະບາຍດີ! ຂ້ອຍຕ້ອງການສັ່ງກາເຟ:
          
          📦 ຜະລິດຕະພັນ: ${variant.name}
          🔥 ການຄົ່ວ: ${variant.roast_label}
          🫘 ແບບເມັດ/ບົດ: ${variant.grind_type}
          💰 ລາຄາ: ${variant.price.toLocaleString()} LAK
          ⚖️ ນ້ຳໜັກ: ${variant.weight}
          🔗 ລິ້ງ: ${window.location.origin}/coffee/${variant.slug}/
          
          ກະລຸນາແຈ້ງວິທີຈັດສົ່ງ ແລະ ການຊຳລະເງິນ
          ຂອບໃຈ!`;
          
            const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
          
            // Try opening in a new tab; if blocked, fall back to same-tab navigation
            const win = window.open(url, '_blank');
            if (!win) window.location.href = url;
          },
      }));
    });
</script>
    

<script>
// Taobao-style Image Gallery JavaScript
let currentImageIndex = 0;
let images = [];
let scrollOffset = 0;
const maxVisibleThumbnails = 5;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize image gallery
    initializeGallery();

    // Video thumbnail hover play/pause
    document.querySelectorAll('[data-type="video"]').forEach(videoThumbnail => {
        const videoElement = videoThumbnail.querySelector('video');
        if (videoElement) {
            videoThumbnail.addEventListener('mouseenter', () => {
                videoElement.play();
            });
            videoThumbnail.addEventListener('mouseleave', () => {
                videoElement.pause();
                videoElement.currentTime = 0; // Reset video to start
            });
        }
    });

    // Mouse wheel support for thumbnail scrolling
    const thumbnailContainer = document.getElementById('thumbnail-container');
    if (thumbnailContainer && thumbnailContainer.parentElement) {
        thumbnailContainer.parentElement.addEventListener('wheel', function(e) {
            e.preventDefault();
            if (e.deltaY > 0) {
                scrollThumbnailsDown();
            } else {
                scrollThumbnailsUp();
            }
        });
    }
});

function initializeGallery() {
    // Collect all media items in DOM order to maintain correct positioning
    const allThumbnails = document.querySelectorAll('[data-image], [data-video]');

    images = [];
    allThumbnails.forEach(thumb => {
        if (thumb.hasAttribute('data-image')) {
            images.push({ type: 'image', url: thumb.getAttribute('data-image') });
        } else if (thumb.hasAttribute('data-video')) {
            images.push({ type: 'video', url: thumb.getAttribute('data-video') });
        }
    });

    if (images.length > 1) {
        // Show image counter and navigation
        const counter = document.getElementById('image-counter');
        if (counter) {
            counter.style.display = 'block';
            updateImageCounter();
        }

        // Show scroll buttons if needed
        updateScrollButtons();
    }

    // Hide thumbnail section if only one item or no items
    const thumbnailSection = document.getElementById('thumbnail-section');
    if (images.length <= 1 && thumbnailSection) {
        thumbnailSection.style.display = 'none';
    }
}

// Wrapper functions for onclick/onmouseenter
function setActiveImage(imageUrl, thumbnailElement) {
    setActiveMedia(imageUrl, 'image', thumbnailElement);
}

function setActiveVideo(videoUrl, thumbnailElement) {
    setActiveMedia(videoUrl, 'video', thumbnailElement);
}

function setActiveMedia(mediaUrl, mediaType, thumbnailElement) {
    const mainImage = document.getElementById('main-image');
    const mainVideo = document.getElementById('main-video');

    // Reset main display
    mainImage.classList.add('hidden');
    mainVideo.classList.add('hidden');
    mainVideo.pause();
    mainVideo.currentTime = 0;

    if (mediaType === 'image') {
        mainImage.src = mediaUrl;
        mainImage.classList.remove('hidden');
    } else if (mediaType === 'video') {
        // Completely reset the video element
        mainVideo.pause();
        mainVideo.removeAttribute('src');

        // Remove all child source elements
        while (mainVideo.firstChild) {
            mainVideo.removeChild(mainVideo.firstChild);
        }

        // Create new source element
        const source = document.createElement('source');
        source.src = mediaUrl;
        source.type = 'video/mp4';
        mainVideo.appendChild(source);

        // Reset and load
        mainVideo.currentTime = 0;
        mainVideo.load();
        mainVideo.classList.remove('hidden');

        // Ensure controls are enabled
        mainVideo.controls = true;
        mainVideo.loop = false;

        // Disable volume (mute the video)
        mainVideo.muted = false;
        mainVideo.volume = 1.0; // Set volume to max but hide controls

        // Add ended event listener to disable replay
        mainVideo.onended = function() {
            // Remove controls when video ends to prevent replay
            this.controls = false;
            // Add a restart overlay or just keep it at the end frame
            console.log('Video ended - replay disabled');
        };

        // Try to autoplay
        const playPromise = mainVideo.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.log('Video autoplay prevented, user needs to click play button');
            });
        }
    }

    // Update active thumbnail styling
    const allThumbnails = document.querySelectorAll('[data-image], [data-video]');
    allThumbnails.forEach(thumb => {
        thumb.classList.remove('active-thumbnail', 'border-amber-500', 'shadow-md', 'ring-2', 'ring-amber-100');
        thumb.classList.add('border-gray-200');
        const indicator = thumb.querySelector('.active-indicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    });

    // Add active styling to selected thumbnail
    if (thumbnailElement) {
        thumbnailElement.classList.add('active-thumbnail', 'border-amber-500', 'shadow-md', 'ring-2', 'ring-amber-100');
        thumbnailElement.classList.remove('border-gray-200');
        const indicator = thumbnailElement.querySelector('.active-indicator');
        if (indicator) {
            indicator.style.display = 'flex';
        }
    }

    // Update current index
    currentImageIndex = images.findIndex(item => item.url === mediaUrl && item.type === mediaType);
    updateImageCounter();
    autoScrollToActiveThumbnail();
}

function nextImage() {
    if (images.length <= 1) return;

    currentImageIndex = (currentImageIndex + 1) % images.length;
    const nextMedia = images[currentImageIndex];
    const nextThumbnail = document.querySelector(`[data-${nextMedia.type}="${nextMedia.url}"]`);
    setActiveMedia(nextMedia.url, nextMedia.type, nextThumbnail);
}

function previousImage() {
    if (images.length <= 1) return;

    currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
    const prevMedia = images[currentImageIndex];
    const prevThumbnail = document.querySelector(`[data-${prevMedia.type}="${prevMedia.url}"]`);
    setActiveMedia(prevMedia.url, prevMedia.type, prevThumbnail);
}

function updateImageCounter() {
    const currentIndexEl = document.getElementById('current-index');
    const totalImagesEl = document.getElementById('total-images');

    if (currentIndexEl && totalImagesEl) {
        currentIndexEl.textContent = currentImageIndex + 1;
        totalImagesEl.textContent = images.length;
    }
}

function scrollThumbnailsUp() {
    if (scrollOffset > 0) {
        scrollOffset--;
        updateThumbnailScroll();
        updateScrollButtons();
    }
}

function scrollThumbnailsDown() {
    const maxOffset = Math.max(0, images.length - maxVisibleThumbnails);
    if (scrollOffset < maxOffset) {
        scrollOffset++;
        updateThumbnailScroll();
        updateScrollButtons();
    }
}

function updateThumbnailScroll() {
    const container = document.getElementById('thumbnail-container');
    if (container) {
        const translateY = scrollOffset * 72; // 60px thumbnail + 12px gap
        container.style.transform = `translateY(-${translateY}px)`;
    }
}

function updateScrollButtons() {
    const upBtn = document.getElementById('scroll-up-btn');
    const downBtn = document.getElementById('scroll-down-btn');
    const maxOffset = Math.max(0, images.length - maxVisibleThumbnails);

    if (upBtn) {
        upBtn.style.display = scrollOffset > 0 ? 'flex' : 'none';
    }

    if (downBtn) {
        downBtn.style.display = scrollOffset < maxOffset ? 'flex' : 'none';
    }
}

function autoScrollToActiveThumbnail() {
    const activeIndex = currentImageIndex;

    // Auto-scroll to show active thumbnail
    if (activeIndex < scrollOffset) {
        scrollOffset = activeIndex;
    } else if (activeIndex >= scrollOffset + maxVisibleThumbnails) {
        scrollOffset = Math.max(0, activeIndex - maxVisibleThumbnails + 1);
    }

    updateThumbnailScroll();
    updateScrollButtons();
}


// WhatsApp Order functionality
function orderViaWhatsApp(coffeeName, price, weight) {
    // WhatsApp business number (replace with actual number)
    const phoneNumber = '8562022133733'; // Your WhatsApp business number

    // Create order message
    const message = `ສະບາຍດີ! ຂ້ອຍຕ້ອງການສັ່ງກາເຟ:

📦 ຜະລິດຕະພັນ: ${coffeeName}
💰 ລາຄາ: ${price} LAK
⚖️ ນ້ຳໜັກ: ${weight}
🔗 ລິ້ງ: ${window.location.href}

ກະລຸນາແຈ້ງລາຍລະອຽດການຈັດສົ່ງ ແລະ ການຊຳລະເງິນ

ຂອບໃຈ!`;

    // Create WhatsApp URL
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;

    // Open WhatsApp in new window/tab
    window.open(whatsappUrl, '_blank');

    // Track order attempt (optional analytics)
    console.log('WhatsApp order initiated for:', coffeeName);
}

// Add to wishlist functionality
function addToWishlist(coffeeSlug) {
    // Get existing wishlist from localStorage
    let wishlist = JSON.parse(localStorage.getItem('coffee_wishlist') || '[]');

    // Check if already in wishlist
    if (wishlist.includes(coffeeSlug)) {
        // Remove from wishlist
        wishlist = wishlist.filter(slug => slug !== coffeeSlug);
        localStorage.setItem('coffee_wishlist', JSON.stringify(wishlist));

        // Update button appearance
        const button = event.target.closest('button');
        const icon = button.querySelector('i');
        const text = button.querySelector('span');

        icon.className = 'fas fa-heart text-sm';
        text.textContent = 'ຖືກໃຈ';
        button.className = button.className.replace('bg-amber-500 text-white', 'border-2 border-amber-500 text-amber-600 hover:bg-amber-500 hover:text-white');

        // Show notification
        showNotification('ລຶບອອກຈາກລາຍການທີ່ຖືກໃຈແລ້ວ', 'info');
    } else {
        // Add to wishlist
        wishlist.push(coffeeSlug);
        localStorage.setItem('coffee_wishlist', JSON.stringify(wishlist));

        // Update button appearance
        const button = event.target.closest('button');
        const icon = button.querySelector('i');
        const text = button.querySelector('span');

        icon.className = 'fas fa-heart text-sm text-red-500';
        text.textContent = 'ຖືກໃຈແລ້ວ';
        button.className = button.className.replace('border-2 border-amber-500 text-amber-600 hover:bg-amber-500 hover:text-white', 'bg-amber-500 text-white');

        // Show notification
        showNotification('ເພີ່ມໃສ່ລາຍການທີ່ຖືກໃຈແລ້ວ', 'success');
    }
}

// Show notification function
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;

    // Add to document
    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);

    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Check wishlist status on page load
document.addEventListener('DOMContentLoaded', function() {
    const wishlist = JSON.parse(localStorage.getItem('coffee_wishlist') || '[]');
    const coffeeSlug = '{{ coffee.slug }}';

    if (wishlist.includes(coffeeSlug)) {
        // Update wishlist button to show it's already liked
        const wishlistButton = document.querySelector('[onclick*="addToWishlist"]');
        if (wishlistButton) {
            const icon = wishlistButton.querySelector('i');
            const text = wishlistButton.querySelector('span');

            icon.className = 'fas fa-heart text-sm text-red-500';
            text.textContent = 'ຖືກໃຈແລ້ວ';
            wishlistButton.className = wishlistButton.className.replace('border-2 border-amber-500 text-amber-600 hover:bg-amber-500 hover:text-white', 'bg-amber-500 text-white');
        }
    }
});

// Share functionality
function shareProduct() {
    if (navigator.share) {
        navigator.share({
            title: '{{ coffee.name }}',
            text: '{{ coffee.description|truncatewords:20|default:"Check out this coffee!" }}',
            url: window.location.href
        }).catch(console.error);
    } else {
        // Fallback to copying URL
        navigator.clipboard.writeText(window.location.href).then(() => {
            showNotification('ລິ້ງໄດ້ຖືກຄັດລອກແລ້ວ!', 'success');
        }).catch(() => {
            showNotification('ບໍ່ສາມາດຄັດລອກລິ້ງໄດ້', 'error');
        });
    }
}

// Compare functionality placeholder
function toggleCompare(coffeeId) {
    console.log('Toggle compare for coffee:', coffeeId);
    // Implement your compare logic here
}

</script>

{% endblock %}